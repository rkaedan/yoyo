<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Krishi-Sahayak Offline</title>
  <link rel="stylesheet" href="/static/tailwind.min.css">
  <script src="/static/chart.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-green-200 flex flex-col h-screen">
  <header class="p-3 text-center text-xl font-bold bg-gray-800 text-cyan-400">
    KRISHI-SAHAYAK : CYBERNETIC DATA TERMINAL (OFFLINE)
  </header>

  <main id="chat-log" class="flex-1 overflow-y-auto p-4 space-y-4"></main>

  <footer class="p-3 bg-gray-800 flex items-center gap-2">
    <input id="farmer-query" class="flex-1 p-2 text-black rounded" placeholder="TYPE YOUR QUERYâ€¦">
    <input type="file" id="image-upload" class="hidden" accept="image/*">
    <label for="image-upload" class="bg-cyan-600 text-black px-3 py-2 rounded cursor-pointer">ðŸ“·</label>
    <button id="submit-query" class="bg-lime-500 text-black px-3 py-2 rounded">SEND</button>
  </footer>

<script>
const log=document.getElementById('chat-log');
const query=document.getElementById('farmer-query');
const btn=document.getElementById('submit-query');
const up=document.getElementById('image-upload');

let imgPath=null;

up.addEventListener('change', async()=>{
  const f=up.files[0]; if(!f)return;
  const fd=new FormData(); fd.append('image',f);
  const r=await fetch('/upload_image',{method:'POST',body:fd});
  const j=await r.json(); if(j.path) imgPath=j.path; else alert(j.error);
});

function render(role,text,chart){
  const d=document.createElement('div');
  d.className=role==='user'?'text-right':'text-left';
  const bubble=document.createElement('div');
  bubble.className='inline-block p-3 rounded bg-gray-800 text-sm whitespace-pre-wrap';
  bubble.textContent=text;
  d.appendChild(bubble);

  if(chart){
    const ctn=document.createElement('div'); ctn.className='mt-2 h-48';
    const cv=document.createElement('canvas'); ctn.appendChild(cv);
    d.appendChild(ctn);
    new Chart(cv,{
      type:chart.chartType||'line',
      data:{labels:chart.data.map(x=>x.label),
        datasets:[{label:chart.unit||'',data:chart.data.map(x=>x.value),
          borderColor:'#06B6D4',tension:0.4}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  }
  log.appendChild(d); log.scrollTop=log.scrollHeight;
}

btn.onclick=async()=>{
  const t=query.value.trim(); if(!t){alert('Type something');return;}
  render('user',t);
  query.value=''; btn.disabled=true;
  const res=await fetch('/submit_query',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({text:t,image_path:imgPath})});
  const j=await res.json();
  if(j.text) render('bot',j.text,j.chart);
  else render('bot','ERROR: '+j.error);
  btn.disabled=false; imgPath=null; up.value='';
};
query.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();btn.click();}});
</script>
</body>
</html>
